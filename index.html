<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bookshelver</title>
    <style>
      :root {
        --spacing-1: 0.25rem;
        --spacing-2: 0.5rem;
        --spacing-3: 0.75rem;
        --spacing-4: 1rem;
        --spacing-5: 1.25rem;
        --spacing-6: 1.5rem;
        --spacing-8: 2rem;
        --color-bg: #222222;
        --color-text: #ffffff;
        --color-accent: #4a90e2;
        --color-danger: #e74c3c;
        --color-outline: #ffcc00;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--color-bg);
        color: var(--color-text);
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: var(--spacing-4);
        gap: var(--spacing-4);
      }

      .bookshelf-grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--spacing-3);
        align-content: start;
      }

      .book-item {
        aspect-ratio: 1 / 1.5;
        position: relative;
        cursor: pointer;
        border-radius: var(--spacing-2);
        overflow: hidden;
        transition: transform 0.2s ease;
      }

      .book-item:hover {
        transform: scale(1.05);
      }

      .book-item.selected {
        outline: 3px solid var(--color-outline);
        outline-offset: 2px;
      }

      .book-thumbnail {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.4;
      }

      .control-panel {
        position: fixed;
        bottom: var(--spacing-4);
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: var(--spacing-4);
        border-radius: var(--spacing-3);
        display: flex;
        gap: var(--spacing-3);
        align-items: center;
      }

      .btn {
        padding: var(--spacing-3) var(--spacing-5);
        background-color: var(--color-accent);
        color: var(--color-text);
        border: none;
        border-radius: var(--spacing-2);
        cursor: pointer;
        font-size: 1rem;
        transition: opacity 0.2s ease;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn-danger {
        background-color: var(--color-danger);
      }

      .camera-preview {
        position: fixed;
        bottom: calc(var(--spacing-4) * 2 + 80px);
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 200px;
        background-color: #000;
        border-radius: var(--spacing-2);
        overflow: hidden;
        display: none;
      }

      .camera-preview.active {
        display: block;
      }

      .camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .camera-outline {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 16%;
        border: 2px solid rgba(255, 255, 255, 0.8);
        pointer-events: none;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="bookshelf-grid" id="bookshelfGrid"></div>
    </div>

    <div class="camera-preview" id="cameraPreview">
      <video class="camera-video" id="cameraVideo" autoplay playsinline></video>
      <div class="camera-outline"></div>
    </div>

    <div class="control-panel" id="controlPanel">
      <button class="btn" id="scanBookBtn">Scan Book</button>
      <button class="btn btn-danger hidden" id="removeBookBtn">
        Remove Book
      </button>
    </div>

    <script>
      const state = {
        books: [],
        selectedBookIndex: null,
        cameraStream: null,
      };

      const bookshelfGrid = document.getElementById("bookshelfGrid");
      const scanBookBtn = document.getElementById("scanBookBtn");
      const removeBookBtn = document.getElementById("removeBookBtn");
      const cameraPreview = document.getElementById("cameraPreview");
      const cameraVideo = document.getElementById("cameraVideo");

      function extractVibrantColor(imageData) {
        const data = imageData.data;
        const colorMap = {};
        let maxSaturation = 0;
        let vibrantColor = { r: 128, g: 128, b: 128 };

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          const saturation = max === 0 ? 0 : (max - min) / max;
          const brightness = max / 255;

          if (saturation > 0.3 && brightness > 0.3 && brightness < 0.9) {
            const key = `${Math.round(r / 10) * 10},${Math.round(g / 10) * 10},${Math.round(b / 10) * 10}`;
            colorMap[key] = (colorMap[key] || 0) + 1;

            if (saturation > maxSaturation) {
              maxSaturation = saturation;
              vibrantColor = { r, g, b };
            }
          }
        }

        const sortedColors = Object.entries(colorMap).sort(
          (a, b) => b[1] - a[1],
        );
        if (sortedColors.length > 0) {
          const [r, g, b] = sortedColors[0][0].split(",").map(Number);
          return { r, g, b };
        }

        return vibrantColor;
      }

      function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;

        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h,
          s,
          l = (max + min) / 2;

        if (max === min) {
          h = s = 0;
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

          switch (max) {
            case r:
              h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
              break;
            case g:
              h = ((b - r) / d + 2) / 6;
              break;
            case b:
              h = ((r - g) / d + 4) / 6;
              break;
          }
        }

        return { h: h * 360, s: s * 100, l: l * 100 };
      }

      function sortBooksByColor() {
        state.books.sort((a, b) => {
          const hslA = rgbToHsl(a.color.r, a.color.g, a.color.b);
          const hslB = rgbToHsl(b.color.r, b.color.g, b.color.b);

          if (Math.abs(hslA.h - hslB.h) > 30) {
            return hslA.h - hslB.h;
          }
          return hslA.l - hslB.l;
        });
      }

      function renderBookshelf() {
        bookshelfGrid.innerHTML = "";

        state.books.forEach((book, index) => {
          const bookItem = document.createElement("div");
          bookItem.className = "book-item";
          if (index === state.selectedBookIndex) {
            bookItem.classList.add("selected");
          }
          bookItem.style.backgroundColor = `rgb(${book.color.r}, ${book.color.g}, ${book.color.b})`;

          const thumbnail = document.createElement("img");
          thumbnail.className = "book-thumbnail";
          thumbnail.src = book.thumbnail;
          thumbnail.alt = "Book thumbnail";

          bookItem.appendChild(thumbnail);
          bookItem.addEventListener("click", () => selectBook(index));

          bookshelfGrid.appendChild(bookItem);
        });
      }

      function selectBook(index) {
        if (state.selectedBookIndex === index) {
          state.selectedBookIndex = null;
          removeBookBtn.classList.add("hidden");
        } else {
          state.selectedBookIndex = index;
          removeBookBtn.classList.remove("hidden");
        }
        renderBookshelf();
      }

      function removeSelectedBook() {
        if (state.selectedBookIndex !== null) {
          state.books.splice(state.selectedBookIndex, 1);
          state.selectedBookIndex = null;
          removeBookBtn.classList.add("hidden");
          renderBookshelf();
        }
      }

      async function startCamera() {
        try {
          state.cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          cameraVideo.srcObject = state.cameraStream;
          cameraPreview.classList.add("active");
        } catch (err) {
          console.error("Camera access denied:", err);
          alert("Unable to access camera");
        }
      }

      function stopCamera() {
        if (state.cameraStream) {
          state.cameraStream.getTracks().forEach((track) => track.stop());
          state.cameraStream = null;
          cameraPreview.classList.remove("active");
        }
      }

      function captureSnapshot() {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        const videoWidth = cameraVideo.videoWidth;
        const videoHeight = cameraVideo.videoHeight;

        canvas.width = 500;
        canvas.height = 500;

        const cropHeight = videoWidth / 5;
        const cropY = (videoHeight - cropHeight) / 2;

        ctx.drawImage(
          cameraVideo,
          0,
          cropY,
          videoWidth,
          cropHeight,
          0,
          0,
          500,
          500,
        );

        const imageData = ctx.getImageData(0, 0, 500, 500);
        const color = extractVibrantColor(imageData);

        const thumbnail = canvas.toDataURL("image/jpeg", 0.8);

        state.books.push({ thumbnail, color });
        sortBooksByColor();
        renderBookshelf();

        stopCamera();
      }

      scanBookBtn.addEventListener("click", () => {
        if (state.cameraStream) {
          stopCamera();
        } else {
          startCamera();
        }
      });

      cameraVideo.addEventListener("click", captureSnapshot);
      removeBookBtn.addEventListener("click", removeSelectedBook);

      renderBookshelf();
    </script>
  </body>
</html>
